---
title: "Covid Vignette"
author: "Xavier Genelin"
date: "9/29/2021"
output: 
  github_document:
    toc: True
    html_preview: False
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document is a vignette that'll show how we can retrieve data from an API and perform exploratory analysis. This will use the [Covid API](https://covid19api.com/). We will build our own functions that will collect data from the API and allow a user to interact with it by choosing different endpoints they can retrieve.

## Packages

To be able to interact with the API and manipulate the data we want to return, the following packages will need to be installed and used:

-`tidyverse`  
-`httr`  
-`jsonlite`  

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(httr)
library(jsonlite)
```

## Functions

This will be used in each of the functions to get the data from the API. Just an example for easy copying
```{r}
getAPI <- GET("https://api.covid19api.com/all")

dat <- fromJSON(rawToChar(getAPI$content))

as_tibble(dat)
covidSummary("global")
```

This first function gets access to the covid summary data and allows the user to choose either a global or country summary. The global summary will return one row with data on NewConfirmed, TotalConfirmed, NewDeaths, TotalDeaths, NewRecovered, and TotalRecovered along with the date that this data is from. The country data will show the same data for `r nrow(covidSummary("country"))` countries as well as their country name, country code, and slug.

```{r}
# The user can either choose a global summary or country

covidSummary <- function(type){
  ### you can either select global or country to see the global summary or 
  # the summary by country
  getAPI <- GET("https://api.covid19api.com/summary")
  dat <- fromJSON(rawToChar(getAPI$content))
  
  if(type == "global"){
    output <- as_tibble(dat$Global)
  } else if(type == "country"){
    output <- as_tibble(dat$Countries)
    
    output <- output %>% select("Country", "CountryCode", "Slug", "NewConfirmed", 
                                "TotalConfirmed", "NewDeaths", "TotalDeaths", "NewRecovered", "TotalRecovered", "Date")
  }

  return(output)
}
```



```{r}
getAPI <- GET("https://api.covid19api.com/countries")

dat <- fromJSON(rawToChar(getAPI$content))

as_tibble(dat)
```

The next function will allow the user to either type out the country name, country code, or slug it will return the slug value. This is necessary because country filters need to be the slug, so the user can choose anything and not have later functions error out. So for example, if someone wanted to get data on the United States, they would either have to type in "United States of America", "united-states", "US", or "us".

```{r}
getCountry <- function(country, IDType){
  # This will return a tibble with the country name, the country name in lowercase
  # with dashes instead of spaces (slug), and the country code of length 2
  # For example, if we want the United States:
  # country: United States of America, slug: united-states, id: US
  getAPI <- GET("https://api.covid19api.com/countries")
  dat <- fromJSON(rawToChar(getAPI$content))
  data <- as_tibble(dat)
  
  if(IDType == "country"){
    output <- data %>% filter(Country == country) %>% select(Slug)
  } else if(IDType == "id"){
    output <- data %>% filter(ISO2 == toupper(country)) %>% select(Slug)
  } else if(IDType == "slug"){
    output <- data %>% filter(slug == country) %>% select(Slug)
  } else {
    stop("ERROR: Invalid IDType. Should be country, id, or slug")
  }
  
  if(nrow(output) == 0){
    stop("ERROR: Country not found. Check spelling and possible capitalization")
  }
  return(output)
}

```


Testing to see if this will work as an error for the total function

It works for this one!!!!
```{r}
getAPI <- GET("https://api.covid19api.com/country/united-states/status/confirmed/live?province=ohio")
dat <- fromJSON(rawToChar(getAPI$content))
data <- as_tibble(dat)

data %>% arrange(City)
```

```{r}
getAPI <- GET("https://api.covid19api.com/country/united-states?province=wisconsin")
dat <- fromJSON(rawToChar(getAPI$content))
data <- as_tibble(dat)

data %>% filter(City == "Dane")
```

```{r}
getAPI <- GET("https://api.covid19api.com/dayone/country/united-states?province=utah")
dat <- fromJSON(rawToChar(getAPI$content))
data <- as_tibble(dat)
data
```


The `total` function collects data from the API 

```{r}
total <- function(country, IDType, case = "all") {
  # get the total covid numbers for a country by day
  # user has the option to get all numbers or just confirmed, recovered, or deaths
  # Find an easy way to get the date in here along with the other functions
  # Date needs to be added in after the country and case portions
  if(case == "all"){
    main <- "https://api.covid19api.com/total/country/"
    country <- getCountry(country, IDType)
    url <- paste0(main, country)
    getAPI <- GET(url)
    dat <- fromJSON(rawToChar(getAPI$content))
    output <- as_tibble(dat)
    
  } else if(case != "all"){
    main <- "https://api.covid19api.com/total/country/"
    country <- getCountry(country, IDType)
    url <- paste0(main, country, "/status/", case)
    getAPI <- GET(url)
    dat <- fromJSON(rawToChar(getAPI$content))
    output <- as_tibble(dat)
  } 
  if(output[1,1] == ""){
    stop("ERROR: make sure case is either all, confirmed, recovered, or deaths")
  }
  return(output)
}

total(country= "AL", IDType = "id", case = "recovered")
```

Live data for each country
```{r}
live <- function(country, IDType, case = "all", province = "all") {
  # get the total covid numbers for a country by day
  # user has the option to get all numbers or just confirmed, recovered, or deaths
  if(case == "all"){
    main <- "https://api.covid19api.com/live/country/"
    country <- getCountry(country, IDType)
    url <- paste0(main, country)
    getAPI <- GET(url)
    dat <- fromJSON(rawToChar(getAPI$content))
    output <- as_tibble(dat)
    
  } else if(case != "all"){
    main <- "https://api.covid19api.com/live/country/"
    country <- getCountry(country, IDType)
    url <- paste0(main, country, "/status/", case)
    getAPI <- GET(url)
    dat <- fromJSON(rawToChar(getAPI$content))
    output <- as_tibble(dat)
  } 
  # the country will be missing but it will still have a dataframe of more than 1 row if there's something wrong with the output
  # this will check to see if that error happened to let the user know
  if(output[1,1] == ""){
    stop("ERROR: make sure case is either all, confirmed, recovered, or deaths")
  }
  
  if(province != "all"){
    output <- output %>% filter(Province == province)
  }
  
  return(output)
}
```

```{r}
live(country = "US", IDType = "id", case = " all", province = "Wisconsin")

```


Day one data for each country
```{r}
dayOne <- function(country, IDType, case = "all", province = "all") {
  # get the total covid numbers for a country by day
  # user has the option to get all numbers or just confirmed, recovered, or deaths
  if(case == "all"){
    main <- "https://api.covid19api.com/dayone/country/"
    country <- getCountry(country, IDType)
    url <- paste0(main, country)
    getAPI <- GET(url)
    dat <- fromJSON(rawToChar(getAPI$content))
    output <- as_tibble(dat)
    
  } else if(case != "all"){
    main <- "https://api.covid19api.com/dayone/country/"
    country <- getCountry(country, IDType)
    url <- paste0(main, country, "/status/", case)
    getAPI <- GET(url)
    dat <- fromJSON(rawToChar(getAPI$content))
    output <- as_tibble(dat)
  } 
  if(output[1,1] == ""){
    stop("ERROR: make sure case is either all, confirmed, recovered, or deaths")
  }
  
  if(province != "all"){
    output <- output %>% filter(Province == province)
  }
  
  return(output)
}
```

```{r}
dayOne(country = "AU", IDType = "id", case = "deaths")
```

Create one final function that uses the other functions above to collect whatever data is needed
```{r}
covid <- function(func, ...){
  if(func == "total"){
    output <- total(...)
  } else if(func == "live"){
    output <- live(...)
  } else if(func == "dayOne"){
    output <- dayOne(...)
  } else if(func == "summary"){
    output <- covidSummary(...)
  } else {
    stop("ERROR: choose total, live, dayOne, or summary as function")
  }
  return(output)
}
```

```{r}
covid("summary", "country")

covid("live", "gb", "id", "confirmed") %>% arrange(Province, Date) #%>% filter(Province == "Wisconsin")
```

Trying to get the province since some countries like the united states won't allow for the whole thing to be brought in because it's too large.
```{r}
test <- GET("https://api.covid19api.com/dayone/country/united-states")
another <- fromJSON(rawToChar(test$content))
print(another)
```



## Data Exporation




